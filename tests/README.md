# AMM 数学公式验证测试套件

## 📖 概述

本测试套件专门用于验证 PancakeSwap 集成中 AMM (自动化做市商) 数学公式的正确性。基于 Uniswap V2 协议，确保滑点计算、价格影响分析和流动性池操作的数学准确性。

## 🧮 验证的数学公式

### 1. 恒定乘积公式
```
x × y = k
```
其中 x 和 y 是两种代币的储备量，k 是常量。

### 2. 交易输出计算（含手续费）
🔧 **PancakeSwap v2 正确手续费: 0.25%**
```
Δy = (Δx × 9975 × y) / (x × 10000 + Δx × 9975)
```

其中:
- `Δx`: 输入的代币数量
- `Δy`: 输出的代币数量  
- `9975/10000`: 扣除 0.25% 手续费

### 3. 滑点计算公式
```
滑点 = (理论输出 - 实际输出) / 理论输出 × 100%
理论输出 = Δx × (y/x) × (1 - 手续费)
```

### 4. 汇率关系
```
有效汇率 < 交易后汇率 < 交易前汇率
```
在大额交易中，有效汇率会被拖低，体现AMM的非线性特性。

## 🚀 使用方法

### 运行完整测试套件
```bash
node run-math-tests.js
```

### 运行单独的测试模块
```javascript
const AMMValidationSuite = require('./tests/amm-math-validation');

async function runSpecificTests() {
  const testSuite = new AMMValidationSuite();
  
  // 运行特定测试
  await testSuite.testConstantProductFormula();
  await testSuite.testSlippageCalculation();
  
  // 查看结果
  testSuite.printTestSummary();
}
```

## 📊 测试覆盖范围

### 1. AMM 恒定乘积公式验证
- ✅ k值因手续费正确增加
- ✅ k值增加幅度合理性检查
- ✅ 恒定乘积机制验证

### 2. 滑点计算数学公式验证  
- ✅ 滑点为正数验证
- ✅ 滑点随交易量递增验证
- ✅ 滑点计算公式正确性

### 3. 手动计算一致性验证
- ✅ 手动 AMM 计算 vs 函数计算
- ✅ 数值精度验证 (误差 < 0.01%)
- ✅ 计算结果一致性

### 4. 边界情况处理
- ✅ 极小交易处理
- ✅ 大额交易警告
- ✅ 无效输入错误处理

### 5. 数学理论正确性
- ✅ 滑点非线性增长特性
- ✅ 小额交易滑点合理性
- ✅ AMM 凸函数特性验证

### 6. 价格影响计算验证
- ✅ 价格影响与滑点一致性
- ✅ 汇率变化逻辑正确性
- ✅ AMM 特性符合预期

## 📈 预期测试结果

正常情况下，所有测试应该通过 (100% 成功率)：

```
📊 测试结果总结
==================================================
✅ 通过: 15
❌ 失败: 0  
📈 总计: 15
🎯 成功率: 100.00%

🎉 所有测试通过！AMM 数学公式实现正确。
```

## 🔧 自定义测试

### 添加新的验证点
```javascript
// 在 AMMValidationSuite 类中添加新方法
async testCustomValidation() {
  try {
    // 你的测试逻辑
    const result = await this.pancakeswap.calculateSlippage(/* 参数 */);
    
    // 验证条件
    const isValid = /* 你的验证条件 */;
    this.recordTest('自定义验证', isValid, '详细说明');
    
  } catch (error) {
    this.recordTest('自定义验证', false, error.message);
  }
}
```

### 测试不同代币
```javascript
// 修改测试代币地址
const testToken = '0x你的代币地址';
```

## ⚠️ 故障排除

### 常见问题

1. **RPC连接失败**
   - 检查 `config/config.js` 中的 `BSC_RPC_URL`
   - 确保网络连接正常

2. **代币不存在**
   - 验证代币地址正确性
   - 确认代币在BSC网络上存在

3. **流动性池不存在**
   - 检查代币是否有对应的交易对
   - 尝试不同的基础代币 (WBNB, BUSD, USDT)

4. **测试超时**
   - 网络延迟导致，可重试
   - 考虑使用更快的RPC节点

## 📚 数学原理说明

### AMM 工作原理
AMM 基于恒定乘积公式，确保流动性池始终有足够的流动性。当有人进行交易时，输入代币增加，输出代币减少，但乘积基本保持不变（除了手续费收入）。

### 滑点产生原因
滑点来源于 AMM 的非线性定价机制。大额交易会显著改变池子的代币比例，导致后续交易获得更差的价格，这就是"价格影响"或"滑点"。

### 手续费处理
PancakeSwap 收取 0.3% 的交易手续费，其中一部分分配给流动性提供者，一部分用于协议运营。这导致每次交易后 k 值会略微增加。

## 🤝 贡献指南

欢迎为测试套件贡献代码：

1. 添加新的验证测试
2. 改进测试覆盖范围  
3. 优化测试性能
4. 完善文档说明

请确保新增的测试符合数学原理，并有详细的注释说明。 